<!-- concerts/templates/concerts/_concert_people_modal.html -->

<div class="space-y-6">
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
  <div>
    <h2 class="text-lg font-semibold">People &amp; Roles</h2>
    <p class="text-sm opacity-70">{{ concert.title }}</p>
  </div>

  <section class="space-y-3">
    <h3 class="text-sm font-semibold uppercase opacity-70">Current assignments</h3>
    {% if roles_by_type %}
      <div class="space-y-3 text-sm">
        {% for role_type, people in roles_by_type.items %}
          <div>
            <div class="text-xs uppercase opacity-60">{{ role_type.name }}</div>
            <ul class="mt-1 space-y-1">
              {% for role in people %}
                <li class="flex flex-wrap items-center justify-between gap-2">
                  <span>{{ role.person }}</span>
                  <button
                    type="button"
                    class="btn btn-ghost btn-xs"
                    hx-post="{% url 'concerts:concert_people_remove_hx' concert.pk role_type.id %}"
                    hx-target="#concert-people-modal-body"
                    hx-swap="innerHTML"
                    hx-include="[name='csrfmiddlewaretoken']"
                    hx-vals='{"role_id": "{{ role.id }}"}'
                  >
                    Remove
                  </button>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm opacity-60">No roles assigned yet.</p>
    {% endif %}
  </section>

  <section class="space-y-3">
    <div class="flex items-center justify-between gap-3">
      <h3 class="text-sm font-semibold uppercase opacity-70">Add more</h3>
      <button type="button" class="btn btn-outline btn-xs" id="role-add-toggle">
        Add more...
      </button>
    </div>

    <div id="role-add-panel" class="hidden space-y-3">
      <div class="form-control w-full">
        <label class="label"><span class="label-text">Role</span></label>
        <select class="select select-bordered w-full" id="role-type-select">
          <option value="">Select a role...</option>
          {% for role_type in role_types %}
            <option value="{{ role_type.id }}">{{ role_type.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-control w-full">
        <label class="label"><span class="label-text">Search</span></label>
        <input
          type="text"
          name="q"
          id="person-search"
          class="input input-bordered w-full"
          placeholder="Type a name..."
          disabled
        >
        <div class="mt-2">
          <div id="person-search-loading" class="htmx-indicator text-xs opacity-60">Searching...</div>
          <div id="person-search-results"></div>
        </div>
        <input type="hidden" name="person_id" id="selected-person-id" />
        <p class="text-xs opacity-60 mt-2">
          Selected:
          <strong id="selected-person-display" class="font-semibold">None</strong>
        </p>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <button
          type="button"
          class="btn btn-primary btn-sm"
          id="add-person-button"
          disabled
        >
          Add person
        </button>
        <button
          type="button"
          class="btn btn-ghost btn-sm"
          id="add-person-modal-button"
          disabled
        >
          Add new person
        </button>
      </div>
    </div>
  </section>
</div>

<script>
  (function () {
    const toggle = document.getElementById("role-add-toggle");
    const panel = document.getElementById("role-add-panel");
    const roleSelect = document.getElementById("role-type-select");
    const searchInput = document.getElementById("person-search");
    const addButton = document.getElementById("add-person-button");
    const addNewButton = document.getElementById("add-person-modal-button");
    const selectedId = document.getElementById("selected-person-id");
    const selectedDisplay = document.getElementById("selected-person-display");
    const concertId = "{{ concert.pk }}";

    if (!toggle || !panel || !roleSelect || !searchInput || !addButton || !addNewButton) return;

    function resetPersonSelection() {
      selectedId.value = "";
      selectedDisplay.textContent = "None";
      addButton.disabled = true;
    }

    toggle.addEventListener("click", () => {
      panel.classList.toggle("hidden");
    });

    roleSelect.addEventListener("change", () => {
      const roleId = roleSelect.value;
      resetPersonSelection();
      if (!roleId) {
        searchInput.disabled = true;
        addNewButton.disabled = true;
        searchInput.removeAttribute("hx-get");
        return;
      }
      searchInput.disabled = false;
      addNewButton.disabled = false;
      searchInput.setAttribute("hx-get", `/concerts/${concertId}/hx/people/${roleId}/search/`);
      addButton.setAttribute("hx-post", `/concerts/${concertId}/hx/people/${roleId}/add/`);
      addButton.setAttribute("hx-target", "#concert-people-modal-body");
      addButton.setAttribute("hx-swap", "innerHTML");
      addButton.setAttribute("hx-include", "[name='csrfmiddlewaretoken']");
      addButton.setAttribute("hx-vals", "js:{person_id: document.getElementById('selected-person-id').value}");
      addNewButton.setAttribute("hx-get", `/people/hx/add/?concert_id=${concertId}&role_type_id=${roleId}`);
      addNewButton.setAttribute("hx-target", "#person-form-target");
      addNewButton.setAttribute("hx-on::after-swap", "person_modal.showModal()");
      if (window.htmx) {
        window.htmx.process(searchInput);
        window.htmx.process(addButton);
        window.htmx.process(addNewButton);
      }
    });

    document.addEventListener("click", (event) => {
      const button = event.target.closest("[data-person-id]");
      if (!button) return;
      selectedId.value = button.dataset.personId;
      selectedDisplay.textContent = button.dataset.personName;
      addButton.disabled = false;
    });
  })();
</script>

{% if close_person_modal %}
  <script>
    if (window.person_modal) {
      person_modal.close();
    }
  </script>
{% endif %}
