<!-- music/templates/music/_music_orgs_modal.html -->
{% load widget_tweaks %}

<div class="space-y-6">
  <div>
    <h2 class="text-lg font-semibold">Availability &amp; Ownership</h2>
    <p class="text-sm opacity-70">{{ music.title }}</p>
  </div>

  <section class="space-y-2">
    <h3 class="text-sm font-semibold uppercase opacity-70">Current relationships</h3>
    {% if music.organization_links.exists %}
      {% regroup music.organization_links.all by role_type as org_links_by_type %}
      <div class="space-y-3 text-sm">
        {% for group in org_links_by_type %}
          <div>
            <div class="text-xs uppercase opacity-60">{{ group.grouper.name }}</div>
            <div class="mt-1 space-y-1">
              {% for link in group.list %}
                <div class="flex flex-wrap items-center justify-between gap-2">
                  <span>
                    {{ link.organization.name }}
                    {% if link.start_date or link.end_date %}
                      <span class="text-xs opacity-60">
                        (
                        {% if link.start_date %}{{ link.start_date|date:"F j, Y" }}{% else %}?{% endif %}
                         -
                        {% if link.end_date %}{{ link.end_date|date:"F j, Y" }}{% else %}present{% endif %}
                        )
                      </span>
                    {% endif %}
                  </span>
                  <form
                    method="post"
                    hx-post="{% url 'music:music_org_link_delete' music.pk link.pk %}"
                    hx-target="#music-orgs-modal-body"
                    hx-swap="innerHTML"
                    hx-on::after-request="if (event.detail.successful && event.detail.requestConfig.verb === 'post') document.getElementById('music-orgs-modal').close()"
                  >
                    {% csrf_token %}
                    <button type="submit" class="btn btn-ghost btn-xs">Remove</button>
                  </form>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-sm opacity-60">No organization relationships are recorded.</p>
    {% endif %}
  </section>

  <section>
    <h3 class="text-sm font-semibold uppercase opacity-70">Add relationship</h3>
    <form
      method="post"
      hx-post="{% url 'music:music_org_link_add' music.pk %}"
      hx-target="#music-orgs-modal-body"
      hx-swap="innerHTML"
      hx-on::after-request="if (event.detail.successful && event.detail.requestConfig.verb === 'post') document.getElementById('music-orgs-modal').close()"
    >
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div class="grid gap-3 sm:grid-cols-2">
        <div class="form-control w-full sm:col-span-2">
          {{ form.organization.label_tag }}
          {% render_field form.organization class="select select-bordered w-full" %}
          {{ form.organization.errors }}
        </div>
        <div class="form-control w-full sm:col-span-2">
          {{ form.role_type.label_tag }}
          {% render_field form.role_type class="select select-bordered w-full" %}
          {{ form.role_type.errors }}
        </div>
        <div class="form-control w-full">
          {{ form.start_date.label_tag }}
          {% render_field form.start_date class="input input-bordered w-full" %}
          {{ form.start_date.errors }}
        </div>
        <div class="form-control w-full">
          {{ form.end_date.label_tag }}
          {% render_field form.end_date class="input input-bordered w-full" %}
          {{ form.end_date.errors }}
        </div>
        <div class="form-control w-full sm:col-span-2">
          {{ form.notes.label_tag }}
          {% render_field form.notes class="textarea textarea-bordered w-full" %}
          {{ form.notes.errors }}
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button type="submit" class="btn btn-primary btn-sm">Add relationship</button>
        {% if is_modal %}
          <button type="button" class="btn btn-ghost btn-sm" onclick="document.getElementById('music-orgs-modal').close()">Cancel</button>
        {% else %}
          <a class="btn btn-ghost btn-sm" href="{% url 'music:music_edit' music.pk %}">Cancel</a>
        {% endif %}
      </div>
    </form>
  </section>

  <div class="divider">Quick add organization</div>
  <form
    method="post"
    hx-post="{% url 'music:music_org_quick_add_hx' music.pk %}"
    hx-target="#music-orgs-modal-body"
    hx-swap="innerHTML"
  >
    {% csrf_token %}
    <div class="form-control w-full">
      <label class="label"><span class="label-text">Organization name</span></label>
      {% render_field organization_quick_form.name class="input input-bordered w-full" %}
      {% if organization_quick_form.name.errors %}
        <label class="label"><span class="label-text-alt text-error">{{ organization_quick_form.name.errors.0 }}</span></label>
      {% endif %}
    </div>
    <div class="mt-3 flex justify-end">
      <button type="submit" class="btn btn-outline btn-sm">Add organization</button>
    </div>
  </form>
</div>
