<!-- music/templates/music/_music_roles_modal.html -->
{% load widget_tweaks %}

{% if created_person %}
  <input type="hidden" id="id_person" name="person" value="{{ created_person.pk }}" hx-swap-oob="true">
  <strong id="person-display" hx-swap-oob="true">{{ created_person }}</strong>
{% endif %}

<div class="space-y-6">
  <div>
    <h2 class="text-lg font-semibold">People &amp; Roles</h2>
    <p class="text-sm opacity-70">{{ music.title }}</p>
  </div>

  <section class="space-y-2">
    <h3 class="text-sm font-semibold uppercase opacity-70">Current assignments</h3>
    {% if roles %}
      <ul class="space-y-2 text-sm">
        {% for role in roles %}
          <li class="flex flex-wrap items-center justify-between gap-2">
            <span>{{ role.person }} â€” {{ role.role_type.name }}</span>
            <form
              method="post"
              hx-post="{% url 'music:music_role_delete' music.id role.pk %}"
              hx-target="#music-roles-modal-body"
              hx-swap="innerHTML"
              hx-on::after-request="if (event.detail.successful && event.detail.requestConfig.verb === 'post') document.getElementById('music-roles-modal').close()"
            >
              {% csrf_token %}
              <button type="submit" class="btn btn-ghost btn-xs">Remove</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-sm opacity-60">No people are assigned.</p>
    {% endif %}
  </section>

  <section>
    <h3 class="text-sm font-semibold uppercase opacity-70">Add person to role</h3>
    <form
      method="post"
      hx-post="{% url 'music:music_roles_edit' music.pk %}"
      hx-target="#music-roles-modal-body"
      hx-swap="innerHTML"
      hx-on::after-request="if (event.detail.successful && event.detail.requestConfig.verb === 'post') document.getElementById('music-roles-modal').close()"
    >
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div class="form-control w-full mt-3">
        <label class="label"><span class="label-text">Person</span></label>
        <input
          type="text"
          id="person-search"
          name="q"
          placeholder="Search by name..."
          class="input input-bordered w-full"
          hx-get="{% url 'people:person_hx_search' %}"
          hx-trigger="keyup delay:300ms"
          hx-target="#person-search-results"
          hx-indicator="#person-search-loading"
          autofocus
        />
        <div class="mt-2">
          <div id="person-search-loading" class="htmx-indicator text-xs opacity-60">
           Searching...
          </div>
          <div id="person-search-results"></div>
        </div>
        <input type="hidden" name="person" id="id_person" />
        <p class="text-xs opacity-60 mt-2">
          Selected:
          <strong id="person-display" class="font-semibold">None</strong>
        </p>
      </div>

      <div class="form-control w-full mt-3">
        {{ form.role_type.label_tag }}
        {% render_field form.role_type class="select select-bordered w-full" %}
        {{ form.role_type.errors }}
      </div>

      <div class="form-control w-full mt-3">
        {{ form.display_order.label_tag }}
        {% render_field form.display_order class="input input-bordered w-full" %}
        {{ form.display_order.errors }}
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button type="submit" class="btn btn-primary btn-sm">Add</button>
        {% if is_modal %}
          <button type="button" class="btn btn-ghost btn-sm" onclick="document.getElementById('music-roles-modal').close()">Cancel</button>
        {% else %}
          <a class="btn btn-ghost btn-sm" href="{% url 'music:music_edit' music.pk %}">Cancel</a>
        {% endif %}
      </div>
    </form>
  </section>

  <div class="divider">Quick add person</div>
  <form
    method="post"
    hx-post="{% url 'music:music_person_quick_add_hx' music.pk %}"
    hx-target="#music-roles-modal-body"
    hx-swap="innerHTML"
  >
    {% csrf_token %}
    <div class="grid gap-3 sm:grid-cols-2">
      <div class="form-control w-full">
        <label class="label"><span class="label-text">First name</span></label>
        {% render_field person_quick_form.first_name class="input input-bordered w-full" %}
      </div>
      <div class="form-control w-full">
        <label class="label"><span class="label-text">Last name / Ensemble name</span></label>
        {% render_field person_quick_form.last_name class="input input-bordered w-full" %}
        {% if person_quick_form.last_name.errors %}
          <label class="label"><span class="label-text-alt text-error">{{ person_quick_form.last_name.errors.0 }}</span></label>
        {% endif %}
      </div>
      <div class="form-control w-full sm:col-span-2">
        <label class="label"><span class="label-text">Display name</span></label>
        {% render_field person_quick_form.display_name class="input input-bordered w-full" %}
      </div>
      <div class="form-control w-full sm:col-span-2">
        <label class="label"><span class="label-text">Type</span></label>
        {% render_field person_quick_form.person_type class="select select-bordered w-full" %}
        {% if person_quick_form.person_type.errors %}
          <label class="label"><span class="label-text-alt text-error">{{ person_quick_form.person_type.errors.0 }}</span></label>
        {% endif %}
      </div>
    </div>
    <p class="text-xs opacity-70 mt-2">This person will be flagged for librarian review.</p>
    <div class="mt-3 flex justify-end">
      <button type="submit" class="btn btn-outline btn-sm">Add person</button>
    </div>
  </form>
</div>
