<!-- music/templates/music/music_detail.html -->

{% extends 'base.html' %}

{% block content %}
<section class="container mx-auto px-6 py-8">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <h1 class="text-3xl font-semibold">{{ music.title }}</h1>
      <p class="text-sm opacity-70">Music detail</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a class="btn btn-ghost btn-sm" href="{% url 'music:music_list' %}">Back to list</a>
      {% if user.is_staff %}
        <a class="btn btn-primary btn-sm" href="{% url 'music:music_edit' music.pk %}">Edit</a>
      {% endif %}
    </div>
  </div>

  {% if not music.is_active %}
    <div class="alert alert-warning mt-4">
      <span>This piece is inactive (archived) and not part of the current library.</span>
    </div>
  {% endif %}

  <div class="grid gap-6 mt-6 lg:grid-cols-3 lg:items-stretch">
    <div class="lg:col-span-2 flex flex-col gap-6 lg:h-full">
      <div class="card bg-base-100 shadow-sm border border-base-200 flex-none">
        <div class="card-body">
          <h2 class="card-title">General Info</h2>
          <dl class="mt-3 grid gap-4 sm:grid-cols-2">
            <div>
              <dt class="text-xs uppercase opacity-60">Composer</dt>
              <dd class="mt-1 text-sm">
                {% if composer_people %}
                  {% for person in composer_people %}
                    {{ person }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  <span class="opacity-60">--</span>
                {% endif %}
              </dd>
            </div>
            <div>
              <dt class="text-xs uppercase opacity-60">Arranger</dt>
              <dd class="mt-1 text-sm">
                {% if arranger_people %}
                  {% for person in arranger_people %}
                    {{ person }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  <span class="opacity-60">--</span>
                {% endif %}
              </dd>
            </div>
            <div>
              <dt class="text-xs uppercase opacity-60">Location</dt>
              <dd class="mt-1 text-sm">
                {% if music.location_drawer %}
                  Drawer {{ music.location_drawer }}, Folder {{ music.location_number }}
                {% else %}
                  <span class="opacity-60">--</span>
                {% endif %}
              </dd>
            </div>
            <div>
              <dt class="text-xs uppercase opacity-60">Duration</dt>
              <dd class="mt-1 text-sm">{{ music.get_duration_display }}</dd>
            </div>
          </dl>
        </div>
      </div>

      <div class="card bg-base-100 shadow-sm border border-base-200 flex-1">
      <div class="card-body">
        <h2 class="card-title">Performance History</h2>
        <div class="mt-4">
          {% if music.program_appearances.exists %}
            <ul class="divide-y divide-base-200">
              {% for appearance in music.program_appearances.all %}
                <li class="py-3 flex flex-wrap items-center justify-between gap-3">
                  <div>
                    <div class="font-medium">
                      <a class="link link-hover" href="{% url 'concerts:concert_detail' appearance.concert.pk %}">
                        {{ appearance.concert.title }}
                      </a>
                    </div>
                    <div class="text-sm opacity-70">
                      {{ appearance.concert.date|date:"F j, Y, g:i a"|default:"TBD" }}
                    </div>
                  </div>
                  {% with recording=appearance.recordings.first %}
                    {% if recording %}
                      <a
                        class="tooltip tooltip-left"
                        href="{{ recording.audio_file.url }}"
                        data-tip="Listen/download recording"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-cyan-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 9.75v4.5m3-6v7.5m3-9v10.5M4.5 5.25v13.5A1.5 1.5 0 0 0 6 20.25h12a1.5 1.5 0 0 0 1.5-1.5V5.25A1.5 1.5 0 0 0 18 3.75H6a1.5 1.5 0 0 0-1.5 1.5Z" />
                        </svg>
                      </a>
                    {% endif %}
                  {% endwith %}
                  {% if appearance.notes %}
                    <div class="text-sm opacity-60">
                      {{ appearance.notes }}
                    </div>
                  {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-sm opacity-60">No performance history recorded yet.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-sm border border-base-200 h-full">
      <div class="card-body">
        <h2 class="card-title">Additional Information</h2>
        <div class="mt-3 space-y-4 text-sm">
          <div class="grid gap-3 sm:grid-cols-2">
            <div>
              <div class="text-xs uppercase opacity-60">Year Composed</div>
              <div class="mt-1">
                {{ music.year_composed|default:"--" }}
              </div>
            </div>
            <div>
              <div class="text-xs uppercase opacity-60">Difficulty</div>
              <div class="mt-1">
                {{ music.get_difficulty_display|default:"--" }}
              </div>
            </div>
            <div class="sm:col-span-2">
              <div class="text-xs uppercase opacity-60">Publisher</div>
              <div class="mt-1">
                {% if publisher_links %}
                  {% for link in publisher_links %}
                    {{ link.organization.name }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  <span class="opacity-60">--</span>
                {% endif %}
              </div>
            </div>
          </div>
          <div>
            <div class="text-xs uppercase opacity-60">Genres</div>
            <div class="mt-1">
              {% for genre in music.genres.all %}
                <span class="badge badge-ghost mr-1 mb-1">{{ genre.name }}</span>
              {% empty %}
                <span class="opacity-60">--</span>
              {% endfor %}
            </div>
          </div>
          <div>
            <div class="text-xs uppercase opacity-60">Current Status</div>
            <div class="mt-1">
              {% with badge=music.get_availability_badge %}
                {% if badge %}
                  <span class="badge badge-outline">{{ badge }}</span>
                {% else %}
                  <span class="badge badge-success">Available</span>
                {% endif %}
              {% endwith %}
            </div>
          </div>
          <div>
            <div class="text-xs uppercase opacity-60">Ownership Details</div>
            <div class="mt-1">
              {% if ownership_links %}
                {% regroup ownership_links by role_type as org_links_by_type %}
                <div class="space-y-2">
                  {% for group in org_links_by_type %}
                    <div>
                      <div class="text-xs uppercase opacity-60">{{ group.grouper.name }}</div>
                      <div class="mt-1">
                        {% for link in group.list %}
                          <div>
                            {{ link.organization.name }}
                            {% if link.start_date or link.end_date %}
                              <span class="text-xs opacity-60">
                                (
                                {% if link.start_date %}{{ link.start_date }}{% else %}?{% endif %}
                                 -
                                {% if link.end_date %}{{ link.end_date }}{% else %}present{% endif %}
                                )
                              </span>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <span class="opacity-60">No organization links.</span>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-xs uppercase opacity-60">Flags</div>
            <div class="mt-1 flex flex-wrap gap-1">
              {% if music.score_missing %}
                <span class="badge badge-warning">Score missing</span>
              {% endif %}
              {% if music.needs_review %}
                <span class="badge badge-info">Needs review</span>
              {% endif %}
              {% if not music.score_missing and not music.needs_review %}
                <span class="opacity-60">--</span>
              {% endif %}
            </div>
          </div>
          <div>
            <div class="text-xs uppercase opacity-60">Notes</div>
            <div class="mt-1 text-sm">
              {% if music.notes %}
                {{ music.notes|linebreaks }}
              {% else %}
                <span class="opacity-60">No notes added.</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    
  </div>
</section>

{% endblock %}
